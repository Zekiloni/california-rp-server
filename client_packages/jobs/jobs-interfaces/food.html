<!DOCTYPE html>
<html>
<head>
   <!-- meta tags-->
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

   <!-- source -->
   <link rel="stylesheet" type="text/css" href="src/vendor/css/fonts.css" />
   <link rel="stylesheet" type="text/css" href="src/vendor/css/font-awesome.css" />

   <link rel="stylesheet" type="text/css" href="src/vendor/css/leaflet.css" />
   <link rel="stylesheet" type="text/css" href="src/styles/food.css" />

</head>
<body>

   <div id="food">
      <div class="header">
         <h2> Dostava Hrane </h2>
         <h4> Porudžbine su označene na mapi tačkama </h4>
      </div>
      <div id="map"> </div>
      <ul class="orders">
         <li class="order" v-for="(order, i) in Orders" v-on:click="Fly(order)"> 
            <h2 class="title"> 
               Narudžbina <b> {{ i + 1 }}</b>
               <small v-bind:style="{ color: Status(order.Status).color }"> {{ Status(order.Status).name }} </small> 
               <small class="contact"> Kontakt <b> {{ order.Contact }} </b></small>

            </h2>

            <div class="order-info">
               <ul class="items">
                  <li v-for="(item, i) in order.Items"> {{ item }} </li>
               </ul>
            </div>
            
         </li>
      </ul>
   </div>
      
   <!-- scripts -->
   <script src="src/vendor/js/vue.js"> </script>
   <script src="src/vendor/js/leaflet.js"> </script>
   <script src="src/vendor/js/leaflet-hash.js"> </script>

   <script>      
      let food = new Vue({
         el: '#food',
         data: {

            Map: null,

            Orders: [
               { Position: {x: -1196.48, y: -1844.86, z: 20.03 }, Items: ['Pizza', 'Donut'], Contact: '321 199', Status: 0 },
               { Position: { y: -1269.81, x: -1915.66, z: 6.22 }, Items: ['Burger', 'Fries'], Contact: 'N / A', Status: 1 },
               { Position: { x: 791.39, y: -1193.9, z: 51.59 }, Items: ['Chips'], Contact: 'N / A', Status: 2 },
               { Position: { x: -1374.98, y: -524.72, z: 32.53 }, Items: ['Chips'], Contact: 'N / A', Status: 2 },
               { Position: { x: -2069.2, y: -1022.98, z: 11.49 }, Items: ['Chips'], Contact: 'N / A', Status: 2 }
                
            ]
         },

         mounted () { 
            this.Initialize();
         },

         methods: { 

            Close: () => { mp.trigger('client:job.food:deliveries'); },

            Initialize: function () { 
    

               let center_of_map_offset_x = 234.75;
               let center_of_map_offset_y = 332.75;
               let scale_x_axis = 0.03990;
		         let scale_y_axis = 0.05050;

               L.CRS.FocusCRS = L.extend({}, L.CRS.Simple, {
                  projection: L.Projection.LonLat, // LongLat Projection
                  transformation: new L.Transformation(scale_x_axis, center_of_map_offset_x, -scale_y_axis, center_of_map_offset_y), // Apply Transform to compensate for GTAV differences

                  distance: function (pos1, pos2) {
                     var x_difference = pos2.lng - pos1.lng;
                     var y_difference = pos2.lat - pos1.lat;
                     return Math.sqrt(x_difference * x_difference + y_difference * y_difference);
                  },
                  scale: function (zoom) {
                     return Math.pow(2, zoom);
                  },
                  zoom: function (sc) {
                     return Math.log(sc) / 0.6931471805599453;
                  },
                  infinite: true
               });

               this.Map = new L.Map("map", {
                  crs: L.CRS.FocusCRS
               });

               layer = L.tileLayer('src/images/tiles/normal/minimap_sea_{y}_{x}.png', {
                  minZoom: -2,
                  maxZoom: 2,
                  tileSize: 1024,
                  maxNativeZoom: 0,
                  bounds: [[0, 0], [-8192, 8192]],
                  tms: true,
                  noWrap: false, 
               }).addTo(this.Map);

               this.Map.setView([-1192.7,-135.1], 3);

               this.Map.on('click', function(e) {
                  alert("Lat, Lon : " + e.latlng.lat + ", " + e.latlng.lng)
               });
            
               const Icon = L.icon({
                  iconUrl: 'order.png',
                  iconSize: [15, 15],
               });
               
               this.Orders.forEach(Order => {
                  const Coords = this.convertToMap(Order.Position.x, Order.Position.y);
                  console.log(Coords)
                  Order.Marker = L.marker(new L.LatLng(Coords.lat, Coords.lng), { icon: Icon }).addTo(this.Map);
               });
               
            },

            Status: (i) => { 
               const Config = [
                  { color: '#adadad', name: 'Naručeno' },
                  { color: '#fbc60c', name: 'Dostavlja se...' },
                  { color: '#2ed076', name: 'Dostavljeno' }
               ];
               return Config[i];
            },

            convertToMap: function (x, y) {
               var game_1_x = -4000.00 - 270;
               var game_1_y = 8000.00 + 420;
               var game_2_x = 400.00 - 30;
               var game_2_y = -300.0 - 340.00;
               
               var h = 1024 * 3,
                  w = 1024 * 2;

               let latLng1 = this.Map.unproject([0, 0], 0);
               let latLng2 = this.Map.unproject([w / 2, (h - 1024)], 0);

               var rLng = latLng1.lng + (x - game_1_x) * (latLng1.lng - latLng2.lng) / (game_1_x - game_2_x);
               var rLat = latLng1.lat + (y - game_1_y) * (latLng1.lat - latLng2.lat) / (game_1_y - game_2_y);
               return result = {
                  lat: rLat,
                  lng: rLng
               };
            },

            Fly: function (order) { 
               this.Map.flyTo([order.Position.y, order.Position.x], 4)
            },
            
   
            Accept: function (i) { 

            },

         }
      })

   </script>
</body>     
</html>
